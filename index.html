<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Discord chat</title>
</head>
<body>
    <div>
        <h1>Chat</h1>
        <div>
            <h2>Messages</h2>
            <div>
                <ul id="chatmessages">
                </ul>
            </div>
            <form>
                <input id="chatmessage" type="text" placeholder="message to channel #heaven">
                <input id="sendButton" type="button" value="send">
            </form>

        </div>
    </div>
</body>
</html>

<style>
    ul{
        max-height: 300px;
        overflow: auto;
    }
    ul li {
        list-style: none;
    }
</style>

<script>
const config = require("./config.json");
const Discord = require('discord.js');
const client = new Discord.Client();

const ul = document.getElementById("chatmessages");
const messageInputfield = document.getElementById("chatmessage");
const sendButton = document.getElementById("sendButton");

try{

    client.on('ready', () => {

        const channel = client.channels.get(config.channel_id)
        channel.fetchMessages()
            .then( messages => {
                Array.from(messages).reverse().forEach( message => {
                    let createdTime = createTime(message[1].createdTimestamp)
                    let text = document.createTextNode(`[${createdTime}] ${message[1].author.username}: ${message[1].content}`);
                    addMessage(text, ul)
                })
            });

    });

    client.on('message', message => {
        let createdTime = createTime(message.createdTimestamp)
        let text = document.createTextNode(`[${createdTime}] ${message.author.username}: ${message.content}`);
        addMessage(text, ul)
    });

    sendButton.addEventListener('click', () => {
        sendMessage();
    } );

    client.login(config.token);

} catch(e){
    //console.log(e);
}

const createTime = timestamp => {
    const date = new Date(timestamp)
    return `${date.getHours()}:${(date.getMinutes()<10?'0':'') + date.getMinutes()}`
}

const addMessage = (text, chatElement) => {
    let li = document.createElement("li")
    li.append(text);
    chatElement.appendChild(li);
}

const sendMessage = () => {
    const message = messageInputfield.value;
    messageInputfield.value = "";
    client.channels.get(config.channel_id).send(message);
}

</script>
